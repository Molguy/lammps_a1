# Reference: M. Orsi, Comparative assessment of the ELBA coarse-grained
# model for water, Molecular Physics (2014), 112, 1566-1576

units real
atom_style full
read_data spc_water_1000mol_box31.1.dat
  orthogonal box = (0 0 0) to (31.1 31.1 31.1)
  2 by 2 by 2 MPI processor grid
  reading atoms ...
  3000 atoms
  scanning bonds ...
  2 = max bonds/atom
  scanning angles ...
  1 = max angles/atom
  reading bonds ...
  2000 bonds
  reading angles ...
  1000 angles
  2 = max # of 1-2 neighbors
  1 = max # of 1-3 neighbors
  1 = max # of 1-4 neighbors
  2 = max # of special neighbors
  special bonds CPU = 0.000296967 secs
  read_data CPU = 0.00786684 secs
include forcefield.SPC.dat
# Berendsen et al, in "Intermolecular forces", p. 331 (1981)
# Charges and geometry are specified in the "data." file.

mass 1 1.00794 # H
mass 2 15.9994 # O

pair_style lj/cut/coul/long 10.0
pair_modify tail yes
kspace_style pppm 1.0e-5

pair_coeff 1 1 0.00000 0.000
pair_coeff 1 2 0.00000 0.000
pair_coeff 2 2 0.15535 3.166

bond_style harmonic
bond_coeff 1 0.0 1.0

angle_style harmonic
angle_coeff 1 0.0 109.47


#replicate 10 10 10

variable Nrun equal 100000
variable Nf equal ${Nrun}/10
variable Nf equal 100000/10
variable Ne equal 10
variable Nr equal ${Nf}/${Ne}
variable Nr equal 10000/${Ne}
variable Nr equal 10000/10
variable Ndump equal ${Nrun}/2
variable Ndump equal 100000/2
variable Nr_rdf equal 0.5*${Nrun}/${Ne}
variable Nr_rdf equal 0.5*100000/${Ne}
variable Nr_rdf equal 0.5*100000/10
variable t  equal 1.0

variable watMoleMass equal 18.0153 # /(g/mol)
variable nAvog equal 6.0221415e23 # Avogadro's number
variable watMoleculeMass equal (${watMoleMass}/${nAvog}) # /(g/molecule)
variable watMoleculeMass equal (18.0153/${nAvog}) 
variable watMoleculeMass equal (18.0153/6.0221415e+23) 
variable A3_in_cm3 equal 1e-24 # Angstrom^3 in cm^3
variable nAtoms equal atoms
variable nMolecules equal v_nAtoms/3

variable Text equal 298.15
variable Pext equal 1.0

group hydrogen type 1
2000 atoms in group hydrogen
group oxygen type 2
1000 atoms in group oxygen

velocity all create ${Text} 1234
velocity all create 298.15 1234

neighbor 2.0 bin
neigh_modify every 1 delay 0 check yes
#comm_modify vel yes

timestep 0.2

fix constrain all shake 1.0e-4 100 0 b 1 a 1
  0 = # of size 2 clusters
  0 = # of size 3 clusters
  0 = # of size 4 clusters
  1000 = # of frozen angles
  find clusters CPU = 0.000248242 secs
fix integrate all npt temp ${Text} ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 1 1000.0
fix removeMomentum all momentum 1 linear 1 1 1

compute T all temp
fix TempAve all ave/time ${Ne} ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 1000 ${Nf} c_T
fix TempAve all ave/time 10 1000 10000 c_T

variable P equal press
fix PressAve all ave/time ${Ne} ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 1000 ${Nf} v_P
fix PressAve all ave/time 10 1000 10000 v_P

compute PE all pe pair kspace
variable PE_Mol equal c_PE/v_nMolecules
fix PEAve_Mol all ave/time ${Ne} ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 1000 ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 1000 10000 v_PE_Mol

variable Dens equal v_nMolecules*${watMoleculeMass}/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*1e-24)
fix DensAve all ave/time ${Ne} ${Nr} ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 ${Nr} ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 1000 ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 1000 10000 v_Dens file wat.dens

compute    	msd oxygen msd com yes
#compute         msd all msd com yes
variable        coe_diff equal (c_msd[4]/6/(step*dt+1.0e-6))/10e-5 #(1.0e-9 m^2/s)
fix             9 all vector 10 c_msd[4]
#variable        fitslope equal slope(f_9)/6/(10*dt)
variable        coef_diff equal fitslope[2]/10e-5

fix msd oxygen ave/time 1 1 50 v_coe_diff file wat.diff



#compute rdf_1 all rdf 1000 2 2 # oxygen-oxygen
#fix 10 all ave/time ${Ne} ${Nr_rdf} ${Nrun} c_rdf_1 file wat.rdf mode vector

thermo_style custom step temp f_TempAve press f_PressAve f_PEAve_Mol f_DensAve v_coe_diff
thermo_modify flush yes
thermo ${Nf}
thermo 10000

dump trj all atom 100 wat.lammpstrj

run ${Nrun}
run 100000
PPPM initialization ...
  using 12-bit tables for long-range coulomb (src/kspace.cpp:332)
  G vector (1/distance) = 0.304865
  grid = 27 27 27
  stencil order = 5
  estimated absolute RMS force accuracy = 0.00289623
  estimated relative force accuracy = 8.72192e-06
  using double precision FFTW3
  3d grid and FFT values/proc = 8000 2916
Neighbor list info ...
  update every 1 steps, delay 0 steps, check yes
  max neighbors/atom: 2000, page size: 100000
  master list distance cutoff = 12
  ghost atom cutoff = 12
  binsize = 6, bins = 6 6 6
  1 neighbor lists, perpetual/occasional/extra = 1 0 0
  (1) pair lj/cut/coul/long, perpetual
      attributes: half, newton on
      pair build: half/bin/newton
      stencil: half/bin/3d/newton
      bin: standard
Per MPI rank memory allocation (min/avg/max) = 10.54 | 10.58 | 10.61 Mbytes
Step Temp f_TempAve Press f_PressAve f_PEAve_Mol f_DensAve v_coe_diff 
       0    447.29957            0    3846523.7            0            0            0  0.040127334 
   10000    304.76512    1095.6644   -728.77028    11144.751   -8.0280158   0.83996575    21.532535 
   20000    301.20469    298.07196    173.00799   -410.83825   -9.8546563   0.92920727    12.199567 
   30000    300.80852    298.34985    366.94685   -16.738291   -9.9856627   0.96027942    9.4317144 
   40000    292.04975    298.35179   -24.349677   -24.235235   -9.9838006   0.97227738    7.7862747 
   50000    306.96882    298.13146    310.73913   -15.754994   -9.9599196   0.97313863     7.185211 
   60000    303.15936    297.86678    65.343183    16.000382    -9.989703   0.97197401    6.5862956 
   70000    298.28109    298.26786    700.71106    2.2404275   -9.9309611   0.97191857    6.5107862 
   80000    299.22709    298.49151   -181.90047    25.093064   -9.9273997    0.9799734     6.048847 
   90000    291.25049    297.78848   -496.21614   -44.260888   -9.9405676   0.96789357    5.9206147 
  100000    298.81786    297.83347    823.14575   -2.1007313    -9.979256   0.97004807    5.4551078 
Loop time of 287.654 on 8 procs for 100000 steps with 3000 atoms

Performance: 6.007 ns/day, 3.995 hours/ns, 347.640 timesteps/s
94.1% CPU use with 8 MPI tasks x no OpenMP threads

MPI task timing breakdown:
Section |  min time  |  avg time  |  max time  |%varavg| %total
---------------------------------------------------------------
Pair    | 139.91     | 147        | 154.62     |  40.8 | 51.10
Bond    | 0.029028   | 0.039653   | 0.048806   |   3.3 |  0.01
Kspace  | 71.435     | 79.439     | 86.628     |  55.9 | 27.62
Neigh   | 2.2409     | 2.2428     | 2.2448     |   0.1 |  0.78
Comm    | 12.754     | 12.971     | 13.178     |   4.5 |  4.51
Output  | 0.35593    | 0.39217    | 0.42175    |   3.5 |  0.14
Modify  | 33.397     | 36.366     | 40.189     |  48.9 | 12.64
Other   |            | 9.204      |            |       |  3.20

Nlocal:    375 ave 386 max 364 min
Histogram: 2 0 0 1 1 1 1 0 0 2
Nghost:    5767.25 ave 5796 max 5743 min
Histogram: 2 1 1 0 0 1 1 0 0 2
Neighs:    134614 ave 145652 max 126626 min
Histogram: 3 0 0 0 1 1 2 0 0 1

Total # of neighbors = 1076916
Ave neighs/atom = 358.972
Ave special neighs/atom = 2
Neighbor list builds = 1008
Dangerous builds = 0

#write_restart restart.wat
Total wall time: 0:04:47
