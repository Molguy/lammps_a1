# Reference: M. Orsi, Comparative assessment of the ELBA coarse-grained
# model for water, Molecular Physics (2014), 112, 1566-1576

units real
atom_style full
read_data msingleSPC.dat
  orthogonal box = (0 0 0) to (31.4532 31.4532 31.4532)
  2 by 2 by 2 MPI processor grid
WARNING: Atom style in data file differs from currently defined atom style (src/read_data.cpp:514)
  reading atoms ...
  3000 atoms
  scanning bonds ...
  2 = max bonds/atom
  scanning angles ...
  1 = max angles/atom
  reading bonds ...
  2000 bonds
  reading angles ...
  1000 angles
  2 = max # of 1-2 neighbors
  1 = max # of 1-3 neighbors
  1 = max # of 1-4 neighbors
  2 = max # of special neighbors
  special bonds CPU = 0.000326864 secs
  read_data CPU = 0.00840361 secs
include forcefield.SPC.dat
# Berendsen et al, in "Intermolecular forces", p. 331 (1981)
# Charges and geometry are specified in the "data." file.

mass 1 1.00794 # H
mass 2 15.9994 # O

pair_style lj/cut/coul/long 10.0
pair_modify tail yes
kspace_style pppm 1.0e-5

pair_coeff 1 1 0.00000 0.000
pair_coeff 1 2 0.00000 0.000
pair_coeff 2 2 0.15535 3.166

bond_style harmonic
bond_coeff 1 0.0 1.0

angle_style harmonic
angle_coeff 1 0.0 109.47


#replicate 10 10 10

variable Nrun equal 100000
variable Nf equal ${Nrun}/10
variable Nf equal 100000/10
variable Ne equal 10
variable Nr equal ${Nf}/${Ne}
variable Nr equal 10000/${Ne}
variable Nr equal 10000/10
variable Ndump equal ${Nrun}/2
variable Ndump equal 100000/2
variable Nr_rdf equal 0.5*${Nrun}/${Ne}
variable Nr_rdf equal 0.5*100000/${Ne}
variable Nr_rdf equal 0.5*100000/10
variable t  equal 1.0

variable watMoleMass equal 18.0153 # /(g/mol)
variable nAvog equal 6.0221415e23 # Avogadro's number
variable watMoleculeMass equal (${watMoleMass}/${nAvog}) # /(g/molecule)
variable watMoleculeMass equal (18.0153/${nAvog}) 
variable watMoleculeMass equal (18.0153/6.0221415e+23) 
variable A3_in_cm3 equal 1e-24 # Angstrom^3 in cm^3
variable nAtoms equal atoms
variable nMolecules equal v_nAtoms/3

variable Text equal 298.15
variable Pext equal 1.0

group hydrogen type 1
2000 atoms in group hydrogen
group oxygen type 2
1000 atoms in group oxygen

velocity all create ${Text} 1234
velocity all create 298.15 1234

neighbor 2.0 bin
neigh_modify every 1 delay 0 check yes
#comm_modify vel yes

timestep 0.2

fix constrain all shake 1.0e-4 100 0 b 1 a 1
  0 = # of size 2 clusters
  0 = # of size 3 clusters
  0 = # of size 4 clusters
  1000 = # of frozen angles
  find clusters CPU = 0.000211232 secs
fix integrate all npt temp ${Text} ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 ${Text} 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso ${Pext} ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 ${Pext} 1000.0
fix integrate all npt temp 298.15 298.15 100.0 iso 1 1 1000.0
fix removeMomentum all momentum 1 linear 1 1 1

compute T all temp
fix TempAve all ave/time ${Ne} ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 ${Nr} ${Nf} c_T
fix TempAve all ave/time 10 1000 ${Nf} c_T
fix TempAve all ave/time 10 1000 10000 c_T

variable P equal press
fix PressAve all ave/time ${Ne} ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 ${Nr} ${Nf} v_P
fix PressAve all ave/time 10 1000 ${Nf} v_P
fix PressAve all ave/time 10 1000 10000 v_P

compute PE all pe pair kspace
variable PE_Mol equal c_PE/v_nMolecules
fix PEAve_Mol all ave/time ${Ne} ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 ${Nr} ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 1000 ${Nf} v_PE_Mol
fix PEAve_Mol all ave/time 10 1000 10000 v_PE_Mol

variable Dens equal v_nMolecules*${watMoleculeMass}/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*${A3_in_cm3})
variable Dens equal v_nMolecules*2.99151057808921e-23/(vol*1e-24)
fix DensAve all ave/time ${Ne} ${Nr} ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 ${Nr} ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 1000 ${Nf} v_Dens file wat.dens
fix DensAve all ave/time 10 1000 10000 v_Dens file wat.dens

compute    	msd oxygen msd com yes
#compute         msd all msd com yes
variable        coe_diff equal (c_msd[4]/6/(step*dt+1.0e-6))/10e-5 #(1.0e-9 m^2/s)
fix             9 all vector 10 c_msd[4]
#variable        fitslope equal slope(f_9)/6/(10*dt)
variable        coef_diff equal fitslope[2]/10e-5

fix msd oxygen ave/time 1 1 50 v_coe_diff file wat.diff



#compute rdf_1 all rdf 1000 2 2 # oxygen-oxygen
#fix 10 all ave/time ${Ne} ${Nr_rdf} ${Nrun} c_rdf_1 file wat.rdf mode vector

thermo_style custom step temp f_TempAve press f_PressAve f_PEAve_Mol f_DensAve v_coe_diff
thermo_modify flush yes
thermo ${Nf}
thermo 10000

dump trj all atom 100 wat.lammpstrj

run ${Nrun}
run 100000
PPPM initialization ...
  using 12-bit tables for long-range coulomb (src/kspace.cpp:332)
  G vector (1/distance) = 0.304039
  grid = 27 27 27
  stencil order = 5
  estimated absolute RMS force accuracy = 0.00299537
  estimated relative force accuracy = 9.02048e-06
  using double precision FFTW3
  3d grid and FFT values/proc = 8000 2916
Neighbor list info ...
  update every 1 steps, delay 0 steps, check yes
  max neighbors/atom: 2000, page size: 100000
  master list distance cutoff = 12
  ghost atom cutoff = 12
  binsize = 6, bins = 6 6 6
  1 neighbor lists, perpetual/occasional/extra = 1 0 0
  (1) pair lj/cut/coul/long, perpetual
      attributes: half, newton on
      pair build: half/bin/newton
      stencil: half/bin/3d/newton
      bin: standard
Per MPI rank memory allocation (min/avg/max) = 10.56 | 10.6 | 10.63 Mbytes
Step Temp f_TempAve Press f_PressAve f_PEAve_Mol f_DensAve v_coe_diff 
       0    447.29957            0    16048.503            0            0            0 3.4657289e-19 
   10000    295.46992    368.50275    726.00995    55.044564   -8.9179738   0.93846422    6.3315035 
   20000    308.15451     298.0065   -828.12724   -8.4102283   -9.9531359   0.97796606    5.1097058 
   30000    305.50952    298.02185    464.97397   -6.2695632   -9.9413006     0.970145    4.6077085 
   40000     288.9084    298.52457    103.42683    9.7913197   -9.9724461   0.97257998    4.3994672 
   50000     296.0369     298.0855   -1.7572822    44.482042   -9.9631585   0.98214319    4.4056314 
   60000    296.44889    297.38241    403.28338   -67.404775   -9.9818899   0.96354479    4.4563386 
   70000    295.84782    297.18562    256.95033     45.86078   -10.000629   0.98403489    4.3938733 
   80000    298.42764    296.46082    408.72454    4.8106417     -10.0185   0.98165787     4.309102 
   90000    294.98756     297.2348    359.40101    -21.93828   -9.9726181   0.97288319    4.2449606 
  100000    300.61669    297.98784   -289.33454   -47.797577   -9.9670097   0.97146338     4.231001 
Loop time of 295.645 on 8 procs for 100000 steps with 3000 atoms

Performance: 5.845 ns/day, 4.106 hours/ns, 338.244 timesteps/s
94.5% CPU use with 8 MPI tasks x no OpenMP threads

MPI task timing breakdown:
Section |  min time  |  avg time  |  max time  |%varavg| %total
---------------------------------------------------------------
Pair    | 142.47     | 150.18     | 157.32     |  44.3 | 50.80
Bond    | 0.032201   | 0.036733   | 0.042981   |   1.8 |  0.01
Kspace  | 78.254     | 85.515     | 93.254     |  58.6 | 28.92
Neigh   | 2.3267     | 2.3288     | 2.3313     |   0.1 |  0.79
Comm    | 11.88      | 11.967     | 12.173     |   3.0 |  4.05
Output  | 0.46527    | 0.50224    | 0.53274    |   3.2 |  0.17
Modify  | 32.695     | 35.513     | 39.688     |  50.9 | 12.01
Other   |            | 9.597      |            |       |  3.25

Nlocal:    375 ave 384 max 362 min
Histogram: 1 0 0 0 1 2 1 2 0 1
Nghost:    5759.12 ave 5826 max 5708 min
Histogram: 1 2 1 0 0 1 1 1 0 1
Neighs:    133642 ave 141066 max 126492 min
Histogram: 1 1 1 1 0 0 2 0 1 1

Total # of neighbors = 1069135
Ave neighs/atom = 356.378
Ave special neighs/atom = 2
Neighbor list builds = 982
Dangerous builds = 0

#write_restart restart.wat
Total wall time: 0:04:55
